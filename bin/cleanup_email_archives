#!/usr/bin/env bash
cd /opt/saq || exit 1
source /opt/saq/load_environment

# clear out emails older than 90 days
# we need to get the server_id in the email archives database
hostname=$(hostname)
hostname=${hostname,,}
server_id=$(mysql --defaults-file=/opt/saq/etc/mysql_defaults.email_archive -r -e "SELECT server_id FROM archive_server WHERE hostname = '$hostname'" | sed -e 's/server_id//g')

find -L archive/email/$hostname -mindepth 2 -maxdepth 2 -type f -mtime +90 | while read email
do
    # determine the md5 of the file, which is the filename
    file_name=$(basename $email)
    md5=${file_name/.gz.gpg/}
    #echo "server id $server_id md5 $md5"

    sql="DELETE FROM archive WHERE server_id = $server_id AND md5 = UNHEX('$md5');"

    # delete the index in the database and the email
    mysql --defaults-file=/opt/saq/etc/mysql_defaults.email_archive -e "$sql" && rm "$email" && echo "delete $email"
done

# brotex streams are on their own so just delete the old ones
#find -L archive/smtp_stream -mindepth 3 -maxdepth 3 -type f -name '*.tar.gz.gpg' -mmin +480 -delete
